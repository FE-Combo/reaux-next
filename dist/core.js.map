{"version":3,"file":"core.js","sourceRoot":"","sources":["../framework/core.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { PureComponent, ComponentType } from \"react\";\nimport { Provider } from \"react-redux\";\nimport { createLogger } from \"redux-logger\";\nimport { createStore, applyMiddleware } from \"redux\";\nimport { composeWithDevTools } from \"redux-devtools-extension\";\nimport { createView } from \"./createView\";\nimport { createAction } from \"./createAction\";\nimport {\n  createReducer,\n  setStateAction,\n  setHelperAction\n} from \"./createReducer\";\nimport { asyncMiddleware } from \"./middleware\";\nimport { StateView, BaseModel, AppCache, Exception } from \"./type\";\nimport { Helper } from \"./helper\";\n\nfunction createApp(): { cache: AppCache; helper: Helper } {\n  const cache = {\n    actionHandlers: {},\n    modules: {},\n    store: createStore(\n      createReducer(),\n      composeWithDevTools({})(\n        applyMiddleware(createLogger({ collapsed: true }), asyncMiddleware)\n      )\n    )\n  };\n  const helper = new Helper(cache, (type, payload) => {\n    setHelperAction(type, payload);\n  });\n  asyncMiddleware.run(cache, (exception: Exception) => {\n    helper.exception = exception;\n  });\n  return { cache, helper };\n}\n\nconst { cache, helper } = createApp();\n\nfunction start(\n  Component: ComponentType<any> & {\n    getInitialProps: (context: any) => void;\n  }\n) {\n  return class App extends PureComponent {\n    static async getInitialProps(context: any) {\n      return {\n        appProps:\n          typeof Component.getInitialProps === \"function\"\n            ? await Component.getInitialProps(context)\n            : {}\n      };\n    }\n    render() {\n      return (\n        <Provider store={cache.store}>\n          <Component {...this.props}></Component>\n        </Provider>\n      );\n    }\n  };\n}\n\nfunction register<H extends BaseModel>(\n  handler: H,\n  Component: ComponentType<any>\n) {\n  if (cache.modules.hasOwnProperty(handler.moduleName)) {\n    throw new Error(\n      `module is already registered, module=${handler.moduleName}`\n    );\n  }\n  cache.modules[handler.moduleName] = true;\n  const { actions, actionHandlers } = createAction(handler);\n  cache.actionHandlers = { ...cache.actionHandlers, ...actionHandlers };\n  const View = createView(handler, Component);\n  return { View, actions };\n}\n\nclass Model<S> extends BaseModel<S> {\n  public constructor(readonly moduleName: string, readonly initState: S) {\n    super();\n    if (!cache.store) {\n      throw new Error(\"store unknown!!\");\n    }\n    cache.store.dispatch(\n      setStateAction(moduleName, initState, `@@${moduleName}/initState`)\n    );\n  }\n  get state(): Readonly<S> {\n    return cache.store.getState().app[this.moduleName];\n  }\n  get rootState(): Readonly<StateView> {\n    return cache.store.getState();\n  }\n  setState(newState: Partial<S>) {\n    cache.store.dispatch(\n      setStateAction(\n        this.moduleName,\n        newState,\n        `@@${this.moduleName}/setState[${Object.keys(newState).join(\",\")}]`\n      )\n    );\n  }\n}\n\nexport { start, register, Model, helper };\n"]}